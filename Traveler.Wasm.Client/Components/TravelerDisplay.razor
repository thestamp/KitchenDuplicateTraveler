@using Traveler.Core.Models
@using Traveler.Wasm.Client.Models

<div class="traveler-container">
    @if (!string.IsNullOrEmpty(EventUrl))
    {
        <div class="event-header no-print">
            <MudPaper Class="pa-4 mb-4" Elevation="1">
                <div class="d-flex align-center justify-space-between">
                    <div>
                        <MudText Typo="Typo.h6" GutterBottom="false">@EventName</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@ClubName</MudText>
                    </div>
                    <div class="d-flex gap-2">
                        @if (!string.IsNullOrEmpty(PbnUrl))
                        {
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.Download"
                                       Href="@PbnUrl"
                                       Target="_blank"
                                       Download="tournament.pbn">
                                Download PBN
                            </MudButton>
                        }
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.OpenInNew"
                                   Href="@EventUrl"
                                   Target="_blank">
                            View on BridgeWebs
                        </MudButton>
                    </div>
                </div>
            </MudPaper>
        </div>
    }

    @if (Boards != null && Boards.Any() && !NumberOfBoardsSelected)
    {
        <div class="event-header no-print">
            <MudPaper Class="pa-4 mb-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">
                    How many boards will you play?
                </MudText>
                <MudText Typo="Typo.body2" Class="mb-3" Color="Color.Secondary">
                    Select the number of boards you intend to play in your kitchen duplicate session.
                    A summary table will be generated showing the results sorted by match points.
                </MudText>
                <div class="d-flex align-center gap-2">
                    <MudNumericField @bind-Value="SelectedNumberOfBoards"
                                    Label="Number of Boards"
                                    Variant="Variant.Outlined"
                                    Min="1"
                                    Max="@Boards.Count"
                                    Style="max-width: 200px;" />
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="ConfirmNumberOfBoards"
                               Disabled="@(SelectedNumberOfBoards < 1 || SelectedNumberOfBoards > Boards.Count)">
                        Generate Boards
                    </MudButton>
                </div>
                <MudText Typo="Typo.caption" Class="mt-2">
                    Available boards: 1 to @Boards.Count
                </MudText>
            </MudPaper>
        </div>
    }

    @if (Boards != null && Boards.Any() && NumberOfBoardsSelected)
    {
        <div class="boards-stack">
            @foreach (var board in Boards.Take(SelectedNumberOfBoards))
            {
                <BoardCard GameData="@board" EventName="@EventName" />
            }
            
            <!-- Summary Table at the end -->
            <BoardSummaryTable Boards="@Boards"
                               NumberOfBoards="@SelectedNumberOfBoards"
                               EventName="@EventName" />
        </div>
    }
</div>

@code {
    [Parameter]
    public List<GameData> Boards { get; set; } = new();

    [Parameter]
    public string? EventUrl { get; set; }

    [Parameter]
    public string? EventName { get; set; }

    [Parameter]
    public string? ClubName { get; set; }

    [Parameter]
    public string? PbnUrl { get; set; }

    private int SelectedNumberOfBoards { get; set; }
    private bool NumberOfBoardsSelected { get; set; } = false;

    protected override void OnParametersSet()
    {
        // Default to all boards
        if (Boards != null && Boards.Any() && SelectedNumberOfBoards == 0)
        {
            SelectedNumberOfBoards = Boards.Count;
        }
    }

    private void ConfirmNumberOfBoards()
    {
        if (SelectedNumberOfBoards >= 1 && SelectedNumberOfBoards <= Boards.Count)
        {
            NumberOfBoardsSelected = true;
        }
    }
}

<style>
    .traveler-container {
        width: 100%;
    }

    .event-header {
        margin-bottom: 1rem;
    }

    .boards-stack {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    @@media print {
        .event-header {
            display: none;
        }

        .boards-stack {
            gap: 1rem;
        }

        /* Each board on its own line when printing */
        .boards-stack > * {
            page-break-inside: avoid;
        }
    }
</style>