@using Traveler.Core.Models

<div class="summary-page">
    <MudPaper Class="summary-container" Elevation="3">
        <div class="summary-header">
            <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
                Summary: Boards @FirstBoard - @LastBoard
            </MudText>
            @if (!string.IsNullOrEmpty(EventName))
            {
                <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Secondary">
                    @EventName
                </MudText>
            }
            <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary" Class="mt-2">
                Total scores if you played all @NumberOfBoards boards
            </MudText>
            <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary" Class="mt-1">
                (Sorted by Total Match Points - highest to lowest)
            </MudText>
        </div>

        <MudTable Items="@SummaryRows" Striped="true" Bordered="true" Dense="false" Class="summary-table">
            <HeaderContent>
                <MudTh Class="header-cell">Rank</MudTh>
                <MudTh Class="header-cell">Total Match Points</MudTh>
                <MudTh Class="header-cell">Total Bridge Score</MudTh>
                <MudTh Class="header-cell">Average MP per Board</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd Class="rank-cell">@context.Rank</MudTd>
                <MudTd Class="mp-cell">@context.TotalMatchPoints.ToString("F1")</MudTd>
                <MudTd Class="score-cell">@context.TotalBridgeScore</MudTd>
                <MudTd Class="avg-cell">@context.AverageMatchPoints.ToString("F2")</MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
</div>

@code {
    [Parameter]
    public List<GameData> Boards { get; set; } = new();

    [Parameter]
    public int NumberOfBoards { get; set; }

    [Parameter]
    public string? EventName { get; set; }

    private int FirstBoard => Boards.Any() ? Boards.Min(b => b.GameModel.BoardNumber) : 0;
    private int LastBoard => FirstBoard + NumberOfBoards - 1;

    private List<PairSummary> SummaryRows => CalculateSummaries();

    private class PairSummary
    {
        public int Rank { get; set; }
        public int PairId { get; set; }
        public double TotalMatchPoints { get; set; }
        public int TotalBridgeScore { get; set; }
        public double AverageMatchPoints { get; set; }
    }

    private List<PairSummary> CalculateSummaries()
    {
        // Dictionary to accumulate totals per pair
        var pairTotals = new Dictionary<int, PairSummary>();
        
        // Take only the requested number of boards
        var boardsToUse = Boards.Take(NumberOfBoards).ToList();

        // Process each board
        foreach (var board in boardsToUse)
        {
            // Group score details by their match point value to identify unique pairs
            // Each unique match point value represents a different pair's result
            var scoreIndex = 0;
            foreach (var detail in board.ScoreDetails.Where(d => d.IsStoredScore).OrderByDescending(d => d.MatchPoints))
            {
                // Use the index within this board as a consistent pair identifier
                var pairId = scoreIndex++;
                
                if (!pairTotals.ContainsKey(pairId))
                {
                    pairTotals[pairId] = new PairSummary { PairId = pairId };
                }

                // Add this board's results to the pair's totals
                pairTotals[pairId].TotalMatchPoints += detail.MatchPoints;
                
                // For bridge score, only add positive scores (you don't get negative points, just 0)
                if (detail.Score > 0)
                {
                    pairTotals[pairId].TotalBridgeScore += detail.Score;
                }
            }
        }

        // Calculate averages and sort by total match points
        var sortedPairs = pairTotals.Values
            .Select(p => {
                p.AverageMatchPoints = p.TotalMatchPoints / NumberOfBoards;
                return p;
            })
            .OrderByDescending(p => p.TotalMatchPoints)
            .ThenByDescending(p => p.TotalBridgeScore)
            .ToList();

        // Assign ranks (ties get same rank)
        int currentRank = 1;
        for (int i = 0; i < sortedPairs.Count; i++)
        {
            if (i > 0 && Math.Abs(sortedPairs[i].TotalMatchPoints - sortedPairs[i - 1].TotalMatchPoints) > 0.01)
            {
                currentRank = i + 1;
            }
            sortedPairs[i].Rank = currentRank;
        }

        return sortedPairs;
    }
}

<style>
    .summary-page {
        page-break-before: always;
        padding: 2rem;
    }

    .summary-container {
        padding: 2rem;
        max-width: 900px;
        margin: 0 auto;
    }

    .summary-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid #000000;
    }

    .summary-table {
        font-size: 1.2rem;
        font-weight: 700;
    }

    .header-cell {
        font-weight: 900;
        font-size: 1.2rem;
        background-color: #e0e0e0 !important;
        text-align: center;
        padding: 1rem !important;
        color: #000000;
    }

    .rank-cell {
        font-weight: 900;
        font-size: 1.3rem;
        text-align: center;
        background-color: #e0e0e0;
        padding: 0.8rem !important;
        color: #000000;
    }

    .mp-cell {
        font-weight: 900;
        font-size: 1.5rem;
        text-align: center;
        background-color: #fff3cd;
        padding: 0.8rem !important;
        color: #000000;
    }

    .score-cell {
        font-weight: 900;
        font-size: 1.3rem;
        text-align: center;
        padding: 0.8rem !important;
        color: #000000;
    }

    .avg-cell {
        font-weight: 700;
        font-size: 1.2rem;
        text-align: center;
        color: #000000;
        padding: 0.8rem !important;
    }

    @@media print {
        .summary-page {
            padding: 1rem;
        }

        .summary-container {
            padding: 1rem;
            box-shadow: none !important;
        }

        .summary-table {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .header-cell {
            background-color: #e0e0e0 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color: #000000 !important;
            font-weight: 900;
        }

        .rank-cell {
            background-color: #e0e0e0 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color: #000000 !important;
            font-weight: 900;
        }

        .mp-cell {
            background-color: #fff3cd !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color: #000000 !important;
            font-weight: 900;
        }

        .score-cell {
            color: #000000 !important;
            font-weight: 900;
        }

        .avg-cell {
            color: #000000 !important;
            font-weight: 700;
        }
    }
</style>
